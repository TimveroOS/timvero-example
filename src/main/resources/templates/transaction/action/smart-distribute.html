<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<form
    th:data-action-path="@{${actionPath}}"
    th:action="@{${actionPath}}"
    method="post"
    class="modal-form"
    th:data-title="#{transaction.distribution.plan}"
    id="distribute-plan"
    th:object="${form}"
>
    <div class="form-body">
        <th:block
            th:insert="~{/form/components :: date(#{transaction.date}, 'date', 'v-required')}"/>
        <table class="table">
            <thead>
            <tr>
                <th class="w-35" th:text="#{transaction.credit}">Credit</th>
                <th class="w-30" th:text="#{creditPayment.creditPaymentType}">Payment type</th>
                <th class="w-35" th:text="#{transaction.amount}">Amount</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#maps.isEmpty(plan)}">
                <td colspan="3" class="text-center text-muted">No items</td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="modal-footer">
        <button
            type="button"
            class="btn btn-secondary"
            data-dismiss="modal"
            th:text="#{button.close}"
        >
            Close
        </button>
        <button
            type="submit"
            class="btn btn-success"
            th:text="#{button.apply}"
        >
            Apply
        </button>
    </div>

    <script th:inline="javascript">
        $(document).ready(function () {
            const transactionId = /*[[${transactionId}]]*/ null;
            const actionPath = $('#distribute-plan').data('action-path');
            const $date = $('#date');
            const $tableBody = $('#distribute-plan .table tbody');

            function updatePlanTable(plan) {
                $tableBody.empty();

                if (!plan || Object.keys(plan).length === 0) {
                    $tableBody.append('<tr><td colspan="3" class="text-center text-muted">No items</td></tr>');
                    return;
                }

                Object.keys(plan).forEach(function(creditId) {
                    const creditPayments = plan[creditId];
                    const paymentTypes = Object.keys(creditPayments);

                    paymentTypes.forEach(function(paymentType, index) {
                        const amount = creditPayments[paymentType];
                        const row = $('<tr>');

                        if (index === 0) {
                            row.append($('<td>').attr('rowspan', paymentTypes.length).text(creditId));
                        }

                        row.append($('<td>').text(paymentType));
                        row.append($('<td>').text(formatAmount(amount)));

                        $tableBody.append(row);
                    });
                });
            }

            function formatAmount(amount) {
                if (amount.amount && amount.currency) {
                    const currencyCode = amount.currency.currencyCode || amount.currency;
                    return currencyCode + ' ' + parseFloat(amount.amount).toFixed(2);
                }
                return '';
            }

            function updateAllocationPlan(date) {
                $.get(actionPath + '/get-plan', {
                    transactionId: transactionId,
                    date: date
                })
                .done(function (response) {
                    updatePlanTable(response);
                })
                .fail(function (xhr, status, error) {
                    console.error('Failed to update allocation plan:', error);
                });
            }

            $date.on('change', function () {
                const selectedDate = $(this).val();
                if (selectedDate) {
                    updateAllocationPlan(selectedDate);
                }
            });
        });
    </script>
</form>
</html>