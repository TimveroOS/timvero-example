[[exception-entity]]
= Exception Entity Logging

`ExceptionEntity` provides persistent storage for exceptions that can be resolved without a code change — for example, an error in a document template, a misconfigured scoring script, or an unavailable external service. The exception is linked to the business entity that failed, so the user can see the error on the entity page and retry the operation after fixing the cause.

General application errors should go to your standard error log and exception tracker (Sentry, etc.). `ExceptionEntity` is not a replacement for logging.

== When to Use

Create an `ExceptionEntity` when **all** of these are true:

* The operation failed and **retries are exhausted** (or not applicable)
* The cause is likely **fixable by configuration** (template, script, external service settings) — not a code bug
* The business entity is left in a **stuck state** and needs to be recoverable through the UI

Do **not** create one when:

* The exception is re-thrown — it will appear in the error log naturally
* Retries are still in progress — create one only after the last retry fails
* The error requires a code fix — use the error log and exception tracker

== API

=== External Service Failures

[source,java]
----
exceptionEntityService.saveException(externalServiceUnavailableException);
----

For `ExternalServiceUnavailableException`, which already carries `serviceName` and `messageCode`.

=== Other Exceptions

[source,java]
----
ExceptionEntity saved = exceptionEntityService.saveException(exception, "OfferCalculationService");
----

`serviceName` is informational — used for classification and filtering in the UI.

Both methods run in `@Transactional(propagation = Propagation.REQUIRES_NEW)` — the exception is persisted even if the calling transaction rolls back.

== Linking to a Business Entity

The business entity should hold a reference to `ExceptionEntity` and transition to a failed state. The core's `ProcessExecution` is a good example of this pattern:

[source,java]
----
@Entity
public class ProcessExecution {

    @ManyToOne(fetch = FetchType.LAZY)
    private ExceptionEntity executionException;

    @Enumerated(EnumType.STRING)
    private ProcessExecutionStatus status; // CREATED, PROCESSING, COMPLETED, FAILED, ...
}
----

When an error occurs, the entity stores the reference and moves to `FAILED`:

[source,java]
----
ExceptionEntity saved = exceptionEntityService.saveException(e, "OfferCalculationService");
offer.setExecutionException(saved);
offer.setStatus(OfferStatus.CALCULATION_FAILED);
// Do NOT re-throw — the method completes, entity is saved in failed state
----

The entity page should display the error state, link to the exception detail page (`/exception-entity/{id}`), and provide a retry action (e.g., "Recalculate offer" button). The user opens the exception page to see the full stack trace, fixes the root cause (corrects the script, restores the external service), then retries from the UI.

== UI

Exception log is available at **Tools → Exception log** (`/exception-entity`). The list page supports filtering by date range, service name, and message. Each detail page shows the full message, cause, and stack trace.
