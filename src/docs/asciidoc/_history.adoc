= Entity History

:sourcedir: ../../main/java/com/timvero/example
:templatedir: ../../main/resources/templates

Track and display entity changes over time with automatic timeline views showing who changed what and when.

== Overview

The history system automatically tracks:

* **Entity Creation** - When entities were created and by whom
* **Field Changes** - What fields changed with before/after values
* **Related Entities** - When related entities (comments, payments, etc.) were added
* **Document Events** - Uploads, signatures, and deletions
* **Custom Events** - Business-specific events tailored to your needs

All events are displayed in a unified timeline with icons, dates, and user information.

== Quick Setup

To add history tracking to your entity:

1. Annotate your entity with `@Audited`
2. Create history suppliers extending base classes
3. Add `EntityHistoryTabController` to display the timeline

TIP: The framework provides base supplier classes for common scenarios. For business-specific events, implement custom suppliers.

== How It Works

The history module consists of several components working together:

=== HistoryEventSupplier (Interface)

*What it is:* The base interface that all history suppliers implement.

*What it does:* Defines how to get history events for a specific entity type.

*Key methods:*

* `getRootClass()` - Returns the entity class this supplier handles (e.g., `Product.class`)
* `getHistoryEvents(entity)` - Returns list of history events for the entity
* `getEventPage()` - Returns path to Thymeleaf template for rendering events
* `getEventModel()` - Returns additional data for the template (optional)

*You implement this by:* Extending one of the abstract supplier classes (AbstractAddedHistorySupplier, etc.) rather than implementing directly.

=== HistoryEventProvider (Service)

*What it is:* The central service that collects and provides history events.

*What it does:*

* Automatically finds all `HistoryEventSupplier` beans registered in Spring
* For a given entity, finds all suppliers that handle that entity type
* Calls each supplier to get events
* Aggregates all events and sorts them by date (newest first)
* Returns events ready for display

*Note:* You don't need to register your suppliers anywhere

=== AuditService (Service)

*What it is:* Low-level service for querying Hibernate Envers audit data.

*What it does:*

* Queries the audit tables created by Hibernate Envers
* Returns revision history with before/after states of entities
* Tracks which fields changed and their old/new values
* Supports nested field paths (e.g., `"address.city"`)

*When to use directly:* If you want to create a custom history supplier with your own logic, inject `AuditService` and use it to query audit data. The abstract supplier classes use this internally, so you typically don't need to call it directly unless you're implementing `HistoryEventSupplier` from scratch.

*Note:* This service requires entities to be annotated with `@Audited`.

=== EntityHistoryTabController (Controller)

*What it is:* Abstract controller for adding a History tab to entity detail pages.

*What it does:*

* Automatically creates a History tab on your entity's detail page
* Injects `HistoryEventProvider` to fetch events
* Renders the history timeline using standard Thymeleaf template
* Provides `isVisible()` method to conditionally show/hide the tab

*You use it by:* Creating a class that extends it, specifying your entity type, and annotating with `@Controller`.

== History Supplier Classes

The framework provides several types of history suppliers for different tracking scenarios:

[cols="2,3"]
|===
|Supplier Class |Purpose

|<<tracking-entity-creation,AbstractAddedHistorySupplier>>
|Tracks entity creation

|<<tracking-field-changes,AbstractModifiedHistorySupplier>>
|Tracks field changes with before/after values

|<<tracking-related-entities,AbstractRelatedEntityAddedHistorySupplier>>
|Tracks related entity additions

|<<document-history,DocumentHistorySupplier>>
|Automatically tracks document uploads

|<<signable-document-history,SignableDocumentHistorySupplier>>
|Tracks signable document lifecycle

|<<credit-history,CreditPaymentHistorySupplier>>
|Tracks credit payments and refunds

|<<credit-history,CreditActualSnapshotHistorySupplier>>
|Tracks changes to credit snapshot (status, amounts, etc.)
|===

NOTE: All suppliers are automatically discovered by Spring when annotated with `@Component`. No manual registration needed.

=== AbstractAddedHistorySupplier

*Purpose:* Tracks when an entity is created.

*When to use:* You want to show "Entity created" events in the timeline.

*What you provide:*

* Entity class
* Event type name (i18n key)

*What you get:* Single event showing creation date and who created the entity.

*Template:* Uses standard `/history/fragments/added` template.

=== AbstractModifiedHistorySupplier

*Purpose:* Tracks changes to specific fields in your entity.

*When to use:* You want to show what fields changed with before/after values.

*What you provide:*

* Entity class
* Event type name (i18n key)
* List of tracked fields via `getTrackedFields()` method

*What you get:* Events showing field changes in a table format with old and new values.

*Template:* Uses standard `/history/fragments/modified` template.

*Field tracking features:*

* Simple fields: `"name"`, `"price"`, `"status"`
* Nested fields: `"address.city"`, `"customer.email"`
* Only tracks changes when values actually differ
* Nested objects must also be `@Audited`

=== AbstractRelatedEntityAddedHistorySupplier

*Purpose:* Tracks when related/child entities are added to a parent entity.

*When to use:* You want to show "Comment added", "Payment added", "Line item added" type events in the parent's history.

*What you provide:*

* Parent entity class
* Child entity class
* Event type name (i18n key)
* Custom Thymeleaf template path
* `getRelatedEntities()` method returning the collection of child entities

*What you get:* Event for each related entity creation with your custom template rendering the details.

*Template:* You provide custom template (e.g., `/history/fragments/comment`).

=== DocumentHistorySupplier

*Purpose:* Automatically tracks document uploads for entities with document management.

*When to use:* Your entity implements `HasDocuments` interface.

*What you provide:* Nothing - this is automatically registered as a Spring `@Component`.

*What you get:* Automatic tracking of all document uploads with filename, size, and download links.

*Template:* Uses standard `/history/fragments/entity_document` template.

*Note:* This supplier works for ALL entities implementing `HasDocuments` - no code needed.

=== SignableDocumentHistorySupplier

*Purpose:* Tracks the complete lifecycle of signable documents (contracts, agreements, etc.).

*When to use:* Your entity uses the signable document system.

*What you provide:* Nothing - this is automatically registered as a Spring `@Component`.

*What you get:* Four types of events:

* *GENERATED* - Document generated from template
* *UPLOADED* - New document version uploaded
* *SIGNED* - Document signed
* *DELETED* - Document removed

*Template:* Uses standard `/history/fragments/signable_document` template.

*Note:* This supplier works automatically for all signable documents - no code needed.

[[tracking-entity-creation]]
== Tracking Entity Creation

Use `AbstractAddedHistorySupplier` when you want to track and display when an entity was created.

=== What You Need

1. Entity annotated with `@Audited`
2. History supplier class extending `AbstractAddedHistorySupplier`
3. i18n message for the event type

=== Step-by-Step Guide

==== 1. Ensure Entity is Audited

Your entity must be annotated with `@Audited`:

[source,java]
----
@Entity
@Audited  // Required for history tracking
public class Participant extends AbstractAuditable {
    private ParticipantStatus status;
    private Employment employment;
    // ... other fields
}
----

==== 2. Create the History Supplier

[source,java,indent=0]
----
include::{sourcedir}/admin/participant/history/ParticipantAddedHistorySupplier.java[tags=!*]
----

Key components:

* **`@Component`** - Enables Spring auto-discovery
* **`Participant.class`** - The entity class being tracked
* **`PARTICIPANT_CREATED`** - i18n key for the event type
* **Constructor parameters** - That's all you need to configure!

==== 3. Add i18n Message

In `messages_en.properties`:

[source,properties]
----
history.type.PARTICIPANT_CREATED=Participant created
----

==== 4. Create History Tab Controller

To display the history on the Participant page, create a History tab:

[source,java,indent=0]
----
include::{sourcedir}/admin/participant/tab/ParticipantHistoryTab.java[tags=!*]
----

=== What You Get

When a Participant is created, the history timeline will show:

* Icon: Plus symbol (ADD)
* Event type: "Participant created" (from i18n)
* Date: When the participant was created
* User: Who created it

The History tab will automatically appear on Participant detail pages with the timeline.

[[tracking-field-changes]]
== Tracking Field Changes

Use `AbstractModifiedHistorySupplier` when you want to track changes to specific fields in your entity and display before/after values.

=== What You Need

1. Entity annotated with `@Audited`
2. Nested objects (if any) annotated with `@Audited`
3. History supplier class extending `AbstractModifiedHistorySupplier`
4. i18n message for the event type

=== Step-by-Step Guide

==== 1. Ensure Entity is Audited

Your entity must be annotated with `@Audited` and `@Table` with name:

[source,java]
----
@Entity
@Table(name = "client")  // Required for field localization
@Audited  // Required for history tracking
public class Client extends AbstractAuditable {
    @Embedded
    private IndividualInfo individualInfo;

    @Embedded
    private ContactInfo contactInfo;

    // ... other fields
}
----

NOTE: The `@Table(name = "client")` attribute is required. The table name is used as the prefix for field localization keys (e.g., `client.individualInfo.fullName`).

==== 2. Ensure Nested Objects are Audited

If you're tracking fields in nested objects (using dot notation like `"individualInfo.fullName"`), those nested objects must also be `@Audited`:

[source,java]
----
@Embeddable
@Audited  // Required for tracking nested fields
public class IndividualInfo {
    private String fullName;
    private LocalDate dateOfBirth;
    // ... other fields
}

@Embeddable
@Audited  // Required for tracking nested fields
public class ContactInfo {
    private String email;
    private String phone;
    // ... other fields
}
----

==== 3. Create the History Supplier

[source,java,indent=0]
----
include::{sourcedir}/admin/client/history/ClientModifiedHistorySupplier.java[tags=!*]
----

Key components:

* **Constructor parameters** - Entity class and i18n event key
* **`getTrackedFields()`** - Returns fields to monitor for changes
* **JPA Metamodel constants** - Type-safe field references (e.g., `Client_.INDIVIDUAL_INFO`)
* **Nested field support** - Use dot notation for embedded objects

TIP: Always use JPA metamodel constants (classes ending with `_`) instead of hardcoded strings. This provides compile-time safety when refactoring field names.

==== 4. Add i18n Messages

In `messages_en.properties`:

[source,properties]
----
# Event type
history.type.CLIENT_MODIFIED=Client modified

# Field labels - used in the change table
client.individualInfo.fullName=Full Name
client.individualInfo.dateOfBirth=Date of Birth
client.contactInfo.email=Email
client.contactInfo.phone=Phone
----

The `history.type.*` key is for the event name. The `client.*` keys are for field labels shown in the changes table.

==== 5. Create History Tab Controller

To display the history on the Client page, create a History tab:

[source,java,indent=0]
----
include::{sourcedir}/admin/client/tab/ClientHistoryTab.java[tags=!*]
----

Don't forget to add the tab label to i18n:

[source,properties]
----
client.tab.history=History
----

=== What You Get

When tracked fields in a Client are modified, the history timeline will show:

* Icon: Edit symbol (MODIFY)
* Event type: "Client modified" (from i18n)
* Date: When the changes were made
* User: Who made the changes
* Table showing changed fields with old and new values

[[tracking-related-entities]]
== Tracking Related Entity Additions

Use `AbstractRelatedEntityAddedHistorySupplier` when you want to track when related/child entities are added to a parent entity.

=== What You Need

1. Parent entity annotated with `@Audited`
2. Related entity annotated with `@Audited`
3. History supplier class extending `AbstractRelatedEntityAddedHistorySupplier`
4. Custom Thymeleaf template for displaying the related entity
5. i18n message for the event type

=== Step-by-Step Guide

==== 1. Ensure Entities are Audited

Both parent and related entities must be annotated with `@Audited`:

[source,java]
----
@Entity
@Table(name = "client")
@Audited
public class Client extends AbstractAuditable {
    @OneToMany(mappedBy = Participant_.CLIENT)
    private Set<Participant> participants;
    // ...
}

@Entity
@Table(name = "application")
@Audited
public class Application extends AbstractAuditable {
    @OneToMany(mappedBy = Participant_.APPLICATION, cascade = ALL, fetch = EAGER)
    private Set<Participant> participants;
    // ...
}

@Entity
@Table(name = "participant")
@Audited
public class Participant extends AbstractAuditable {
    @ManyToOne(fetch = EAGER)
    @JoinColumn(nullable = false, updatable = false)
    private Client client;

    @ManyToOne(fetch = EAGER)
    @JoinColumn(nullable = false, updatable = false)
    private Application application;
    // ...
}
----

==== 2. Create the History Supplier

[source,java,indent=0]
----
include::{sourcedir}/admin/client/history/ClientParticipantCreatedEventSupplier.java[tags=!*]
----

Key components:

* **Parent entity class** - `Client.class` - the entity whose history you're tracking
* **Related entity class** - `Participant.class` - the child entity being added
* **Event type** - `"CLIENT_PARTICIPANT_CREATED"` - i18n key
* **Template path** - Custom Thymeleaf template for rendering the event
* **`getRelatedEntities()`** - Returns filtered collection of related entities

In this example, we filter participants who are borrowers. The supplier creates one history event per related entity.

==== 3. Create Custom Template

Create a Thymeleaf template at `/history/fragments/client/participant_created.html`:

[source,html]
----
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="history">
    <div>
        <span th:text="#{history.participant.created}">Participant added:</span>
        <a th:href="@{/participant/{id}(id=${event.relatedEntity.id})}"
           th:text="${event.relatedEntity.displayedName}"></a>
    </div>
</th:block>
</html>
----

The template has access to:

* `event.relatedEntity` - the related entity instance (Participant in this case)
* `event.icon`, `event.type`, `event.date`, `event.auditor` - standard event properties

==== 4. Add i18n Messages

In `messages_en.properties`:

[source,properties]
----
# Event type
history.type.CLIENT_PARTICIPANT_CREATED=Participant added

# Template labels
history.participant.created=Participant added
----

=== What You Get

When a Participant is added to a Client (excluding borrowers), the Client's history timeline will show:

* Icon: Plus symbol (ADD)
* Event type: "Participant added" (from i18n)
* Date: When the participant was created
* User: Who created it
* Custom content: Link to the participant with their name

[[document-history]]
== Automatic Document History

`DocumentHistorySupplier` automatically tracks document uploads for entities with document management.

TIP: This supplier works out of the box - no code needed. Just implement `HasDocuments` interface.

=== How It Works

If your entity implements the `HasDocuments` interface, document uploads are automatically tracked in history.

The framework automatically:

* Detects all entities implementing `HasDocuments`
* Tracks when documents are uploaded
* Shows document filename, size, and download link in history
* Uses standard template `/history/fragments/entity_document`

=== What You Need

1. Entity implements `HasDocuments` interface
2. That's it! No supplier code needed.

=== Example

[source,java]
----
@Entity
@Table(name = "participant")
@Audited
public class Participant extends AbstractAuditable implements HasDocuments {

    @OneToMany(mappedBy = "participant")
    private List<EntityDocument> documents;

    @Override
    public List<EntityDocument> getDocuments() {
        return documents;
    }
}
----

When you upload a document to a Participant, the history timeline automatically shows:

* **Icon** - Document symbol
* **Event type** - Document type name
* **Date** - When the document was uploaded
* **User** - Who uploaded it
* **Document details** - Filename, size, download link

NOTE: No configuration needed - works automatically for all entities implementing `HasDocuments`.

[[signable-document-history]]
== Automatic Signable Document History

`SignableDocumentHistorySupplier` automatically tracks the complete lifecycle of signable documents (contracts, agreements, etc.).

TIP: This supplier works out of the box - no code needed. The system automatically tracks all signable document events.

=== How It Works

If your entity uses the signable document system, the entire document lifecycle is automatically tracked.

The framework automatically tracks four types of events:

* *GENERATED* - Document generated from template
* *UPLOADED* - New document version uploaded
* *SIGNED* - Document signed by a party
* *DELETED* - Document removed

=== What You Need

1. Entity uses signable document system
2. That's it! No supplier code needed.

=== Example

When working with signable documents on Application entity:

[source,java]
----
@Entity
@Table(name = "application")
@Audited
public class Application extends AbstractAuditable {
    // Signable document system is configured
}
----

The history timeline automatically shows:

* **Document Generated** - "Application Form generated"
* **Document Uploaded** - "New version of Application Contract uploaded"
* **Document Signed** - "Application Contract signed by John Doe"
* **Document Deleted** - "Application Form deleted"

Each event includes:

* **Icon** - Appropriate symbol for the action
* **Document type** - e.g., "Application Form", "Application Contract"
* **Date** - When the action occurred
* **User** - Who performed the action
* **Download link** - For accessing the document

NOTE: No configuration needed - works automatically for all signable documents.

[[credit-history]]
== Credit History Tracking

For Credit entities, the framework provides specialized history suppliers that track payments and snapshot changes (status, amounts, etc.).

=== CreditPaymentHistorySupplier

Abstract supplier that tracks credit payment and refund operations. Extend this class to enable payment tracking for your credit entity.

==== Implementation Example

[source,java,indent=0]
----
include::{sourcedir}/admin/credit/history/ExampleCreditPaymentHistorySupplier.java[tags=!*]
----

Key components:

* **Extends `CreditPaymentHistorySupplier`** - Pre-configured for payment tracking
* **`@Component`** - Enables Spring auto-discovery
* **Event type** - `CREDIT_PAYMENT` is predefined
* **Template** - Uses standard `/history/fragments/credit_payment` template

==== What It Tracks

* **Payment events** - When payments are registered
* **Refund events** - When refunds are processed
* **Payment amount** - Amount of each payment/refund
* **Operation type** - Distinguishes between PAYMENT and REFUND

==== Add i18n

In `messages_en.properties`:

[source,properties]
----
history.type.CREDIT_PAYMENT=Payment registered
----

=== CreditActualSnapshotHistorySupplier

Abstract supplier that tracks changes to the Credit's `actualSnapshot` field. Use this to monitor status changes, balance updates, or any snapshot-tracked data.

==== Implementation Example

[source,java,indent=0]
----
include::{sourcedir}/admin/credit/history/ExampleCreditStatusChangedHistorySupplier.java[tags=!*]
----

Key components:

* **Extends `CreditActualSnapshotHistorySupplier`** - Monitors snapshot changes
* **`getEventPage()`** - Returns path to custom template
* **`getEventTitle()`** - Returns event type for i18n
* **`shouldCreateHistoryEvent()`** - Determines when to create events

In this example:

* Monitors `actualSnapshot.status` changes
* Creates event only when status actually changes
* Uses custom template to display old and new status

==== Create Custom Template

Create a Thymeleaf template at `/history/fragments/credit/credit_status_changed.html`:

[source,html]
----
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="history">
    <div>
        <span th:text="#{history.credit.status.changed}"></span>
        <strong th:text="#{${'credit.status.' + event.snapshot.status}}"></strong>
    </div>
</th:block>
</html>
----

The template has access to:

* `event.snapshot` - The CreditSnapshot after the change
* `event.snapshot.status` - Credit status value
* Standard event properties: `event.icon`, `event.type`, `event.date`

==== Add i18n

In `messages_en.properties`:

[source,properties]
----
history.type.CREDIT_STATUS_CHANGED=Credit status changed
history.credit.status.changed=Status changed to
----

==== Other Use Cases

You can track other snapshot changes by implementing different logic in `shouldCreateHistoryEvent()`:

* **Balance changes** - Compare `beforeSnapshot.debt` and `afterSnapshot.debt`
* **Interest rate changes** - Compare rate values
* **Date changes** - Track maturity date or payment schedule updates

TIP: The `CreditSnapshot` contains all credit calculation data at a point in time. You can track any field changes by comparing before/after snapshots.

==== Create History Tab

To display credit history, create a tab controller:

[source,java,indent=0]
----
include::{sourcedir}/admin/credit/tab/CreditHistoryTab.java[tags=!*]
----

Add tab label to i18n:

[source,properties]
----
credit.tab.history=History
----

=== What You Get

When viewing credit history, the timeline shows:

* **Payment events** - With amounts and operation type (PAYMENT/REFUND)
* **Status changes** - New credit status
* **Icon** - Appropriate symbol for each event type
* **Date** - When the event occurred
* **User** - Who performed the action

NOTE: Both suppliers work independently. Create as many `CreditActualSnapshotHistorySupplier` extensions as needed to track different snapshot changes.

[[custom-history-supplier]]
== Custom History Supplier

When the abstract supplier classes don't fit your needs, you can implement `HistoryEventSupplier` directly.

=== When to Use

Use a custom supplier when you need to:

* Query data from multiple services (not just Envers audit tables)
* Apply custom business logic to filter events
* Include additional data that doesn't come from audit tables

=== What You Need

1. Class implementing `HistoryEventSupplier<EntityType, YourCustomEvent>`
2. Custom event class extending `HistoryEvent` with your additional data
3. Custom Thymeleaf template for rendering
4. i18n messages

=== Step-by-Step Guide

==== 1. Create the History Supplier

[source,java,indent=0]
----
include::{sourcedir}/admin/participant/history/ParticipantProcessExecutionsHistorySupplier.java[tags=!*]
----

Key components:

* **`implements HistoryEventSupplier`** - Direct interface implementation for full control
* **Service injection** - Use `@Autowired` to inject business services
* **`getRootClass()`** - Returns the entity class this supplier handles
* **`getEventPage()`** - Returns path to your custom template
* **`getHistoryEvents()`** - Queries data and creates custom events

In this example:

* Injects `ProcessExecutionService` and `DecisionFactService` for data access
* Filters executions by status (only COMPLETED)
* Fetches decision facts for each execution and groups them by value
* Creates custom events with `ProcessExecution` and decision facts

TIP: Use custom suppliers when you need to combine data from multiple services or apply complex business logic that doesn't fit the abstract suppliers.

==== 2. Create Custom Event Class

The custom event class holds your business-specific data:

* Extends `HistoryEvent` (provides icon, type, date, auditor)
* Adds `processExecution` field
* Adds `decisionFacts` map for grouped facts

==== 3. Create Custom Template

Create a Thymeleaf template at `/history/fragments/participant/participant_process_execution.html`:

[source,html,indent=0]
----
include::{templatedir}/history/fragments/participant/participant_process_execution.html[]
----

The template has access to `event` with your custom fields:

* `event.processExecution` - the ProcessExecution object
* `event.decisionFacts` - the decision facts map

==== 4. Add i18n Messages

In `messages_en.properties`:

[source,properties]
----
# Event type
history.type.PARTICIPANT_PROCESS_EXECUTION=Decision tree executed

# Template labels
history.participant.process.execution=Decision tree executed
history.participant.process.execution.facts=Decision facts
----

=== What You Get

When a process execution completes for a Participant, the history timeline will show:

* Icon: Edit symbol (EDIT)
* Event type: "Decision tree executed"
* Date: When the process was created
* Process name: Name of the executed process
* Decision facts: Grouped by value with fact codes