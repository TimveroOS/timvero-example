= Notifications

:sourcedir: ../../main/java/com/timvero/example/admin

This section covers creating and managing automated notifications for loan applications and credit accounts. The notification system provides multi-channel communication (EMAIL, PHONE, LETTER) with template-based content.

== Notification System Overview

The notification system consists of:

* **`NotificationEvent`** - Defines when notifications are triggered
* **`NotificationModel`** - Provides data to notification templates
* **`NotificationTemplate`** - Database-stored templates with dynamic content
* **Notification Gateways** - Handle delivery via EMAIL, PHONE, LETTER

== Creating Notification Events

Notification events define when and how notifications are sent to users.

=== Basic Notification Event

[source,java]
----
include::{sourcedir}/notification/LoanApprovedEvent.java[lines=10..27]
----

Key components:

* **`NotificationEventType`** - Unique identifier for the event type
* **`getType()`** - Returns the event type for template matching
* **`notify()`** - Triggers notification with entity data
* **`isSuitableTestEntity()`** - Determines when event can be tested

=== Event with Custom Data

[source,java]
----
include::{sourcedir}/notification/LoanDeclinedEvent.java[lines=12..29]
----

Custom template models provide specific data for templates:

[source,java]
----
include::{sourcedir}/notification/LoanDeclineTemplateModel.java[lines=7..28]
----

=== Event with Parameters

Events can use EventParameters for template-configurable logic:

[source,java]
----
include::{sourcedir}/notification/PaymentReminderEvent.java[lines=18..31]
----

EventParameters allow admin users to configure notification behavior:

* **`daysCount`** - Configurable number of days for payment reminders
* Used in `entityMatchesTemplate()` to control when notifications are sent

TIP: **EventParameters vs Custom Models**: Use EventParameters when admin users need to configure _when_ notifications send (timing, thresholds). Use Custom Models when templates need additional _data_ not available on the base entity.

Available parameter types:

* **`integerField("name")`** - Days, counts, thresholds
* **`decimalField("name")`** - Amounts, percentages
* **`stringField("name")`** - Categories, codes
* **`enumField("name", values)`** - Predefined choices

== Creating Notification Templates

Templates are created and managed through the admin interface, similar to document templates.

=== Accessing Template Management

Navigate to **System -> Notification Templates** in the admin interface.

=== Creating New Template

1. **Template Details**:
   - **Name**: Descriptive name (e.g., "Loan Approval - Email")
   - **Event Type**: Select from dropdown (e.g., "LOAN_APPROVED")
   - **Gateway Type**: EMAIL, PHONE, or LETTER
   - **Recipient Type**: BORROWER, AGENT, etc.
   - **Active**: Check to enable template

2. **Template Content**: Use WYSIWYG editor with Pebble template syntax

=== Template Content Examples

==== Email Template (Loan Approval) - Minimal

**Subject**: `Loan Approved - {{ application.id | slice(0, 8) | upper }}`

**Body**:
```html
<h2>Congratulations {{ application.client.individualInfo.firstName }}!</h2>
<p>Your {{ application.requestedAmount | currency }} loan has been approved at {{ application.condition.interestRate | numberformat('#,##0.00%') }}.</p>
<p>Documents will be ready within 2 business days.</p>
```

==== SMS Template (Payment Reminder)

```
{% if reminderType == 'UPCOMING' %}
Payment due {{ expectedPaymentDate | date('MM/dd') }}.
{% else %}
Payment overdue by {{ daysCount | abs }} days.
{% endif %}
Account: {{ credit.id | slice(0, 8) | upper }}
Pay online or call (555) 123-4567
```

==== Email Template (Loan Decline)

**Subject**: `Loan Application Update`

**Body**:
```html
<h2>Dear {{ application.client.individualInfo.firstName }},</h2>

{% if declineReason %}
<p><strong>Status:</strong> {{ declineReason.description }}</p>
{% else %}
<p>Your application did not meet our current lending criteria.</p>
{% endif %}

<p>You may reapply after {{ reapplicationWaitDays }} days.</p>
<p>Questions? Call (555) 123-4567.</p>
```

== Template Variables and Functions

=== Available Variables

Templates have access to:

* **Entity data** - All properties from the associated entity (Application, ExampleCredit, etc.)
* **Model data** - Custom data from NotificationModel subclasses
* **Built-in filters** - Date formatting, number formatting, string manipulation

=== Common Pebble Filters

**Date Formatting**:
```
{{ application.createdAt | date('MMMM dd, yyyy') }}     // March 15, 2024
{{ expectedPaymentDate | date('yyyy-MM-dd') }}          // 2024-03-15
```

**Number Formatting**:
```
{{ application.requestedAmount | currency }}                    // $50,000.00
{{ application.condition.interestRate | numberformat('#,##0.00%') }}  // 5.50%
```

**String Operations**:
```
{{ application.id | slice(0, 8) | upper }}              // A1B2C3D4
{{ application.client.individualInfo.firstName | title }}  // John
```

**Conditional Content**:
```
{% if application.status == 'SERVICING' %}
    Your loan is now active.
{% else %}
    Your application is being processed.
{% endif %}
```

**Loops** (for collections):
```
{% for document in application.documents %}
    Document: {{ document.name }}
{% endfor %}
```

== Automatic Notifications

=== Entity Event Listeners

Events can implement `EntityEventListener` to automatically trigger on system events:

[source,java]
----
@Component
public class PaymentReminderEvent extends NotificationEvent<ExampleCredit, PaymentReminderTemplateModel>
    implements EntityEventListener<CreditCalculationDateChangeEvent> {

    public PaymentReminderEvent() {
        super(EventParameter.integerField("daysCount"));
    }

    @Override
    public void handle(CreditCalculationDateChangeEvent event) {
        notify(event.getCreditId(), new PaymentReminderTemplateModel());
    }

    @Override
    protected boolean entityMatchesTemplate(ExampleCredit credit, PaymentReminderTemplateModel model,
                                          Map<String, Object> templateParams) {
        // Use templateParams.get("daysCount") to check if credit matches
        // this specific template's configured day threshold
    }
}
----

This automatically triggers payment reminders when credit calculation dates change, with templates configured for specific day thresholds.

=== EntityChecker Integration

Notifications can be triggered automatically using EntityCheckers:

[source,java]
----
@Component
public class ApplicationStatusNotificationChecker extends EntityChecker<UUID, Application> {

    @Autowired
    private LoanApprovedEvent loanApprovedEvent;

    @Autowired
    private LoanDeclinedEvent loanDeclinedEvent;

    @Override
    protected void registerListeners() {
        register(Application.class, EntityChangeEvent.Operation.UPDATE);
    }

    @Override
    protected boolean isAvailable(Application application) {
        return application.getStatus().in(ApplicationStatus.SERVICING, ApplicationStatus.DECLINE);
    }

    @Override
    protected void perform(Application application) {
        switch (application.getStatus()) {
            case SERVICING -> loanApprovedEvent.notify(application.getId());
            case DECLINE -> loanDeclinedEvent.notify(application.getId(),
                application.getDeclineReason(), true);
        }
    }
}
----

== Notification Gateways

Gateways handle actual delivery of notifications. The `NotificationGatewayType` determines which contact information is used — the recipient entity must implement the `Notifiable` interface providing `getNotificationEmail()`, `getMainNotificationPhone()`, and `getNotificationAddress()`.

=== Gateway Interface

[source,java]
----
public interface NotificationGateway {

    NotificationGatewayType getType();

    String send(Notification notification) throws Exception;

    Map<String, NotificationStatus> check(Collection<String> messageIds) throws Exception;

    default int batchSize() {
        return 100;
    }

    default Duration lifeTime() {
        return Duration.ofHours(2);
    }
}
----

* **`getType()`** - Returns `EMAIL`, `PHONE`, or `LETTER`
* **`send()`** - Sends the notification, returns an external message ID for tracking
* **`check()`** - Checks delivery status for previously sent message IDs. Map provider statuses to `NotificationStatus` values: `SCHEDULED`, `PROCESSED_DELIVERY`, `PERFORMED`, `OPENED`, `ERROR`, `EXPIRED`, `DROPPED`
* **`batchSize()`** - Maximum messages to check in a single `check()` call (default: 100)
* **`lifeTime()`** - How long the system keeps checking delivery status (default: 2 hours)

=== Abstract Gateway Classes

The SDK provides abstract classes that handle content extraction from `DocumentStorage` automatically.

**`AbstractEmailGateway`** — override two methods:

* `defaultSender()` — returns the default "from" address
* `sendEmail(String sender, String email, String subject, String body, List<DocumentResource> attachments)` — sends the email, returns external message ID

The base class extracts HTML body from `Document` content, loads attachments, and resolves the sender via `EmailSenderResolver` (if registered), falling back to `defaultSender()`.

TIP: To use different sender addresses for different notification types, implement the `EmailSenderResolver` interface and register it as a Spring bean. It receives the full `Notification` object and returns the appropriate sender address.

**`AbstractSmsGateway`** — override one method:

* `sendSms(String phone, String message)` — sends the SMS, returns external message ID

NOTE: There is no abstract class for LETTER gateways. Implement `NotificationGateway` directly.

=== Built-in Email Gateways

==== JavaMailSender (Spring Mail / SMTP)

The simplest option using standard Spring Mail SMTP. Import `JavaMailSenderConfiguration` and configure:

[source,yaml]
----
spring:
  mail:
    host: smtp.example.com
    port: 587
    username: your-username
    password: your-password
    sender: noreply@example.com
    properties:
      mail.smtp.auth: true
      mail.smtp.starttls.enable: true
----

Supports HTML content and file attachments. Works with any SMTP provider (Gmail, Amazon SES via SMTP, etc.).

NOTE: SMTP does not support delivery status tracking. The `check()` method always returns `PERFORMED`.

==== Mailgun

Activated automatically when `mailgun.apiKey` property is set:

[source,yaml]
----
mailgun:
  apiKey: key-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
  domain: mg.example.com
  sender: noreply@example.com
  timeout: 30s    # optional, default 30s
----

Supports delivery status tracking via Mailgun Events API.

==== Customer.io

Activated when `customerio.apikey` property is set:

[source,yaml]
----
customerio:
  apikey: your-api-key
  sender: noreply@example.com
----

NOTE: Customer.io transactional email API does not support file attachments.

=== Built-in SMS Gateways

==== Twilio

Activated when `twilio.sid` property is set and Twilio SDK is on the classpath:

[source,yaml]
----
twilio:
  sid: ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
  auth.token: your-auth-token
  sender: "+15551234567"
----

Supports full delivery status tracking via Twilio Message API.

==== Infobip

Activated when `infobip.api.key` property is set and Infobip SDK is on the classpath:

[source,yaml]
----
infobip:
  api:
    key: your-api-key
    url: https://xxxxx.api.infobip.com
  sender: InfoSMS    # optional
----

Supports delivery status tracking.

=== Custom Gateway Implementation

To integrate with a provider not included in the SDK, extend the appropriate abstract class:

[source,java]
----
@Service
@ConditionalOnProperty("myprovider.apiKey")
public class MyEmailGateway extends AbstractEmailGateway {

    @Value("${myprovider.sender}")
    private String sender;

    @Override
    protected String defaultSender() {
        return sender;
    }

    @Override
    protected String sendEmail(String sender, String email, String subject,
                               String body, List<DocumentResource> attachments) throws Exception {
        // Call your email provider API, return external message ID
    }

    @Override
    public Map<String, NotificationStatus> check(Collection<String> messageIds) throws Exception {
        // Query your provider's delivery status API
    }
}
----

For SMS, extend `AbstractSmsGateway` and override `sendSms(String phone, String message)` and `check()`.

=== Development Gateways

The SDK provides dev gateways that log notifications instead of sending them. Activated with the `development` Spring profile:

[source,yaml]
----
spring:
  profiles:
    active: development
----

This registers `DevEmailGateway`, `DevSmsGateway`, and `DevVoiceGateway` via `DevNotificationGatewayConfiguration`. All dev gateways log at DEBUG level and always report `PERFORMED` status.

TIP: In production, dev gateways are replaced automatically — built-in gateways use `@ConditionalOnProperty` and activate only when their provider properties are configured.

== Internationalization (i18n)

The notification system integrates with Spring's message system for localized labels and descriptions.

=== Event Type Labels

Event types are displayed in the admin interface using message keys:

```properties
# messages.properties
notification.event.type.APP_STATUS_CHANGE=Application Status Change
notification.event.type.PAYMENT_REMINDER=Payment Reminder
notification.event.type.LOAN_APPROVED=Loan Approved
notification.event.type.LOAN_DECLINED=Loan Declined
```

The pattern is: `notification.event.type.{EVENT_TYPE_NAME}=Display Name`

=== EventParameter Labels

EventParameter fields are labeled using their parameter names:

```properties
# messages.properties
notification.event.APP_STATUS_CHANGE.status=Status
notification.event.PAYMENT_REMINDER.daysCount=Days Count
notification.event.LOAN_DECLINED.declineReason=Decline Reason
```

The pattern is: `notification.event.{EVENT_TYPE_NAME}.{PARAMETER_NAME}=Field Label`

=== Usage in Admin Interface

These labels appear in:

- **Notification Templates list** - Event type dropdown and display
- **Template configuration** - EventParameter field labels
- **Template testing** - Event selection and parameter forms

== Testing Notifications

=== Template Testing

Use the admin interface to test templates:

1. **Go to Notification Templates**
2. **Select a template**
3. **Click "Test Template"**
4. **Choose a suitable entity** from the dropdown (filtered by `isSuitableTestEntity()`)
5. **Preview the rendered template**

=== Programmatic Testing

[source,java]
----
@Test
public void testLoanApprovalNotification() {
    // Create test application
    Application application = createTestApplication();
    application.setStatus(ApplicationStatus.SERVICING);

    // Test notification
    boolean sent = loanApprovedEvent.notify(application.getId());
    assertTrue(sent);
}
----

== Integration Examples

=== Scheduled Payment Reminders

[source,java]
----
@Component
public class PaymentReminderScheduler {

    @Autowired
    private PaymentReminderEvent paymentReminderEvent;

    @Scheduled(cron = "0 0 9 * * ?") // Daily at 9 AM
    public void sendPaymentReminders() {
        // PaymentReminderEvent handles the business logic
        // Templates configured with different daysCount values will
        // automatically send appropriate reminders
        List<ExampleCredit> activeCredits = creditRepository.findActiveCredits();

        for (ExampleCredit credit : activeCredits) {
            paymentReminderEvent.notify(credit.getId());
        }
    }
}
----

=== Workflow Integration

[source,java]
----
@Component
public class WorkflowCompletionListener implements EntityEventListener<ProcessExecutionFinishedEvent> {

    @Autowired
    private LoanApprovedEvent loanApprovedEvent;

    @Override
    public void handle(ProcessExecutionFinishedEvent event) {
        if ("LOAN_APPROVAL_PROCESS".equals(event.getProcessDefinitionKey())) {
            if ("APPROVED".equals(event.getResult())) {
                loanApprovedEvent.notify(event.getEntityId());
            }
        }
    }
}
----

=== Summary

* **Automatic notifications** - Use EntityChecker for state-driven events
* **Scheduled reminders** - Use EventParameters for admin-configurable timing
* **Workflow notifications** - Listen to process completion events
